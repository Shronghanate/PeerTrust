/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model. All user-related
 * data is stored within a dedicated user document tree, ensuring that users can only
 * access their own information.
 *
 * Data Structure: All data is nested under the top-level `/users` collection, with a
 * structure of `/users/{userId}/{subcollection}/{documentId}`. This path-based ownership
 * allows for simple, performant, and secure authorization checks without needing to read
 * other documents.
 *
 * Key Security Decisions:
 * - User Enumeration Disabled: Listing the top-level `/users` collection is explicitly
 *   denied to protect user privacy.
 * - Profile Visibility: User profiles are readable by any authenticated user to facilitate
 *   app interactions, but are only writable by the owner.
 * - Cross-User Writes: The system safely allows specific cross-user write operations, such
 *   as one user submitting feedback for another. This is secured by validating that the
 *   creator's ID is correctly embedded in the new document.
 * - Shared Access: Feedback requests are accessible to both the requester and the requestee,
 *   enabling collaboration while restricting access to only the involved parties.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the requesting user's UID matches the provided userId.
     * This is the foundation of the user-ownership model.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    /**
     * Verifies that a document already exists.
     * Crucial for protecting update and delete operations from acting on non-existent paths.
     */
    function isExistingDoc() {
      return resource != null;
    }

    /**
     * Combines ownership and existence checks for update/delete operations.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && isExistingDoc();
    }

    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    /**
     * @description Manages user profile documents.
     * @path /users/{userId}
     * @allow (get, list) Any authenticated user can view any user's profile to enable discoverability.
     * @allow (create) An authenticated user can create their own profile document.
     * @allow (update, delete) The owner of the profile can modify or delete it.
     * @deny A user cannot create a profile for another user.
     */
    match /users/{userId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);

      /**
       * @description Manages a user's logged interactions with peers.
       * @path /users/{userId}/interactions/{interactionId}
       * @allow (read) A user can only read their own interaction history.
       * @allow (create) A user can create an interaction document in their own or a peer's history,
       *                but only if they are one of the participants.
       */
      match /interactions/{interactionId} {
        allow get, list: if isOwner(userId);
        allow create: if request.auth.uid == request.resource.data.participant1Id || request.auth.uid == request.resource.data.participant2Id;
        allow update: if isExistingOwner(userId);
        allow delete: if isExistingOwner(userId);
      }

      /**
       * @description Manages feedback documents *received* by a user. The {userId} in the path is the reviewee.
       * @path /users/{userId}/feedback/{feedbackId}
       * @allow (read) A user can read the feedback they have received.
       * @allow (create) An authenticated user can create feedback for another user, if the data is valid.
       */
      match /feedback/{feedbackId} {
        allow get, list: if isOwner(userId);
        allow create: if isSignedIn() && request.resource.data.revieweeId == userId && request.resource.data.reviewerId == request.auth.uid;
        allow update: if isExistingOwner(userId);
        allow delete: if isExistingOwner(userId);
      }
    }
    
    /**
     * @description Manages feedback requests.
     * @path /feedbackRequests/{feedbackRequestId}
     * @allow (read, update) The requester or the requestee can access a feedback request.
     * @allow (create) An authenticated user can create a feedback request for themselves.
     */
    match /feedbackRequests/{feedbackRequestId} {
      allow read, update: if isSignedIn() && (isOwner(resource.data.requesterId) || isOwner(resource.data.requesteeId));
      allow list: if isSignedIn();
      allow create: if isSignedIn() && isOwner(request.resource.data.requesterId);
      allow delete: if false;
    }
    
    /**
     * @description Manages temporary interaction codes.
     * @path /interactionCodes/{codeId}
     * @allow (read) Any authenticated user can read a code to confirm an interaction.
     * @allow (create) A user can create a code for themselves.
     * @allow (delete) A user can delete their own code.
     */
    match /interactionCodes/{codeId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && isOwner(request.resource.data.userId);
      allow delete: if isSignedIn() && isOwner(resource.data.userId);
      allow update: if false;
    }
  }
}
